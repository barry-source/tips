
## 堆和栈的区别

1、 从管理方式来讲

    对于栈来讲，是由编译器自动管理，无需我们手工控制；

    对于堆来说，释放工作由程序员控制，容易产生内存泄露(memory leak)

2、 从申请空间大小方面讲

    栈空间比较小，VS

    堆空间比较大，在32位操作系统上，最高会达到4G

3、 从生长方向方面讲
    
    堆的生长方向向上，内存地址由低到高；
    栈的生长方向向下，内存地址由高到低

4、 从分配方式不同

    堆都是动态分配的，没有静态分配的堆。
    栈有2种分配方式：静态分配和动态分配。静态分配是由操作系统完成的，比如局部变量的分配。动态分配由alloca函数进行分配，但是栈的动态分配和堆是不同的，他的动态分配是由操作系统进行释放，无需我们手工实现

5、 从分配方式不同

    栈由操作系统自动分配，会在硬件层级对栈提供支持：分配专门的寄存器存放栈的地址，压栈出栈都有专门的指令执行，这就决定了栈的效率比较高。
    堆则是由C/C++提供的库函数或运算符来完成申请与管理，实现机制较为复杂，频繁的内存申请容易产生内存碎片。
    显然，堆的效率比栈要低得多。 

6、 从数据存储方面来讲

    栈存放的内容，函数返回地址、相关参数、局部变量和寄存器内容等

    堆空间一般存放对象本身，block 的 copy 等



32位系统只能用4G内存，64位系统最大用多少内存

解： 32位操作系统地址线是32，所以最大寻址能力是2^32，即4GB,所以如果内存多余4GB，多余的部分就浪费了
        64位操作系统地址线最大是64，所以最大寻址能力是2^64 = 2^34 *   2^10(G) * 2^10(M) * 2^10(K)，即17179869184 GB, 即64位cpu理论上支持17多亿GB的内存，
        最新款 Mac Pro 顶配版最大支持 1.5T内存，即1536GB，也就是说主板最大支持的上限，寻址能力是32位的 1536 / 4 = 384倍，介于 2^40 和2^41之间，即地址线数量为41 


## 虚拟内存

> 面试题: 一个进程的地址和物理地址之间的关系是什么？

1 这里涉及虚拟内存概念： 每个程序拥有自己的地址空间，这个空间被分割成多个块，每一块称作一页或页面。每一页有连续的地址范围。
这些页被映射到物理内存，但并不是所有的页都必须在内存中才能运行程序。当程序引用到一部分在物理内存中的地址空间时，由硬件立刻执行必要的映射。当程序引用到一部分不在物理内存中的地址空间时，由操作系统负责将缺失的部分装入物理内存并重新执行失败的指令。

物理地址： 物理地址空间是真实的存在于计算机中的一个实体，在每一台计算机中保持唯一独立性

虚拟地址： 虚拟地址并不真实存在于计算机中。每个进程都分配有自己的虚拟空间，而且只能访问自己被分配使用的物理地址空间

2 程序执行时需要把当前的页的虚拟地址在映射到物理地址上。

MMU（内存管理单元）把虚拟地址映射到物理地址上，

虚拟地址映射到物理地址的方法主要有两种`分页`和`分段`：

##### 分页：

虚拟地址按空间大小划分为若干个`页面`，物理内存中对应的就是`页框`，正常情况下两者大小一样。
分页地址映射如下：
    虚拟地址被分为`虚拟页号`(高位部分)和`页内偏移量`(低位部分),
    `页号`作为`页表`的索引项，`页表`中包含物理页每页所在物理内存中的基地址，通过基地址和`页内偏移量`就找到对应的物理内存地址
    `页表`的作用是把`虚拟页面`映射到`页框`，
    

> 接上一部分： 这样有什么更快的方法去计算物理地址？

加速分页TLB方法：
1、添加硬件设备TLB
2、软件管理TLB

TLB工作原理：

    将一个虚拟地址放入MMU中进行转换时，硬件首先通过将该虚拟页号与TLB中所有表项同时(即并行)进行匹配，判断虚拟页面是否在其中。如果发现了一个有效的匹配并且要进行的访问操作并不违反保护位
    则将页框号直接从TLB中取出而不必再访问页表。如果虚拟页号确实在TLB中,但指令试图在一个只读页面上进行写操作，则会产生一个保护错误，就像对页表进行非法访问一样，
    计当虚拟页号不在TLB中时会怎样呢?进行正常的页表查询，淘汰一个表项，然后用新表项替代

页面置换算法：


1、快速硬件寄存器
2、整个页表都在内存中


##### 分段：

分段机制就是把虚拟地址空间中的虚拟内存组织成一些长度可变的称为段的内存块单元。

每个段由三个参数定义：段基地址、段限长和段属性。

段可以用来存放程序的代码、数据和堆栈，或者用来存放系统数据结构。



三 分段机制和分页机制的区别

　　1、分页机制会使用大小固定的内存块，而分段管理则使用了大小可变的块来管理内存。

　　2、分页使用固定大小的块更为适合管理物理内存，分段机制使用大小可变的块更适合处理复杂系统的逻辑分区。

　　3、段表存储在线性地址空间，而页表则保存在物理地址空间。



[分段分页](https://blog.csdn.net/qq_37924084/article/details/78360003)
